<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kindergarten Math Adventure - AI-powered learning games for children aged 3-6. Dark Material Design theme with adaptive difficulty and offline support.">
    <meta name="keywords" content="kindergarten, math, learning, games, children, education, AI, adaptive">
    <meta name="author" content="Kindergarten Math Adventure">
    
    <!-- Theme and PWA -->
    <meta name="theme-color" content="#1a1a2e">
    <meta name="color-scheme" content="dark">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icons/favicon.ico">
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Kindergarten Math Adventure">
    <meta property="og:description" content="Fun, AI-powered math learning games for young children">
    <meta property="og:type" content="website">
    <meta property="og:image" content="./icons/og-image.png">
    
    <!-- Accessibility -->
    <meta name="screen-reader" content="supported">
    <meta name="high-contrast" content="supported">
    
    <title>Kindergarten Math Adventure</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap" as="style">
    <link rel="preload" href="./src/styles/main.css" as="style">
    
    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'material': {
                            'primary': '#1a1a2e',
                            'secondary': '#16213e',
                            'surface': '#1e1e30',
                            'background': '#0f0f23',
                            'variant': '#252542'
                        },
                        'accent': {
                            'purple': '#9d4edd',
                            'blue': '#5e60ce', 
                            'teal': '#4cc9f0',
                            'pink': '#f72585',
                            'orange': '#fb8500',
                            'green': '#06ffa5'
                        },
                        'pastel': {
                            'purple': '#c77dff',
                            'blue': '#7b68ee',
                            'cyan': '#6dd5ed',
                            'pink': '#ff9a9e', 
                            'orange': '#feca57',
                            'green': '#5fa8d3'
                        },
                        'text': {
                            'primary': '#e8eaed',
                            'secondary': '#bdc1c6',
                            'muted': '#9aa0a6',
                            'accent': '#c77dff'
                        }
                    },
                    fontFamily: {
                        'primary': ['Nunito', 'ui-sans-serif', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Critical CSS from working no-modules version -->
    <style>
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            text-align: center;
            color: #e8eaed;
        }
        
        /* Screen Management */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            min-height: 44px;
            min-width: 44px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            outline: none;
            text-decoration: none;
        }
        
        .btn:focus-visible {
            outline: 3px solid #9d4edd;
            outline-offset: 2px;
        }
        
        .btn-primary {
            background: #9d4edd;
            color: white;
        }
        
        .btn-primary:hover {
            background: #c77dff;
            transform: translateY(-2px);
        }
        
        .btn-primary:disabled {
            background: #252542;
            color: #9aa0a6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #1e1e30;
            color: #e8eaed;
            border: 2px solid #252542;
        }
        
        .btn-secondary:hover {
            background: #252542;
            border-color: #9d4edd;
            transform: translateY(-2px);
        }
        
        .age-group-btn.selected {
            background: #9d4edd !important;
            color: white !important;
            border-color: #9d4edd !important;
            transform: scale(1.05);
        }
        
        /* Cards */
        .card {
            background: #1e1e30;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }
        
        /* Game Cards */
        .game-card {
            background: linear-gradient(145deg, #1e1e30, #252542);
            border-radius: 1.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .game-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.3);
            border-color: #9d4edd;
        }
        
        /* Animations */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @keyframes bounce-in {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-bounce-in { animation: bounce-in 0.6s ease-out; }
        
        /* Utilities */
        .hidden { display: none !important; }
        
        /* Navigation - initially hidden */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: none; /* Hidden by default in fallback mode */
        }
        
        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .nav-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e8eaed;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.25rem;
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #9d4edd;
        }
        
        /* Offline banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fb8500;
            color: white;
            text-align: center;
            padding: 0.5rem;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .offline-banner.show {
            transform: translateY(0);
        }
        
        /* Skip link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #9d4edd;
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1001;
        }
        
        .skip-link:focus {
            top: 6px;
        }
    </style>
</head>
<body class="font-primary bg-material-background text-text-primary antialiased">
    <!-- Skip to main content link for screen readers -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Offline banner -->
    <div id="offline-banner" class="offline-banner" aria-live="polite">
        <span>üåê You're offline - some features may be limited</span>
    </div>
    
    <!-- Loading screen -->
    <div id="loading-screen" class="loading-screen" aria-label="Loading application">
        <div class="loading-content">
            <div class="text-6xl mb-6 animate-bounce">üßÆ</div>
            <h1 class="loading-title">Kindergarten Math Adventure</h1>
            <p class="loading-subtitle">Preparing your magical learning journey...</p>
            <div class="loading-progress">
                <div class="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- Main application container -->
    <div id="app" class="app-container hidden">
        
        <!-- Navigation bar -->
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="nav-content">
                <div class="flex items-center gap-4">
                    <!-- Logo and title -->
                    <div class="flex items-center gap-3">
                        <div class="text-3xl" role="img" aria-label="Math adventure logo">üßÆ</div>
                        <div>
                            <h1 class="text-lg font-bold text-text-primary">Math Adventure</h1>
                            <p class="text-xs text-text-muted" id="user-greeting">Welcome, Explorer!</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <!-- Network status indicator -->
                    <div id="network-status" class="hidden nav-button" aria-label="Network status">
                        <span id="network-icon">üì∂</span>
                    </div>
                    
                    <!-- Settings button -->
                    <button id="settings-btn" class="nav-button" aria-label="Open settings">
                        <span>‚öôÔ∏è</span>
                    </button>
                    
                    <!-- User menu button -->
                    <button id="user-menu-btn" class="nav-button" aria-label="User menu">
                        <span id="user-avatar">üë∂</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main content area -->
        <main id="main-content" class="flex-1 min-h-screen">
            
            <!-- Welcome Screen -->
            <section id="welcome-screen" class="screen active">
                <div class="container mx-auto px-4 py-8">
                    <!-- Hero section -->
                    <div class="text-center mb-12">
                        <div class="text-8xl mb-6 animate-bounce-in">üåü</div>
                        <h2 class="heading-display mb-4">Welcome to Math Adventure!</h2>
                        <p class="text-body max-w-2xl mx-auto mb-8">
                            Embark on a magical journey of numbers, shapes, and patterns. 
                            Our AI-powered games adapt to your learning style for the perfect challenge every time!
                        </p>
                        
                        <!-- Age group selection -->
                        <div class="mb-8">
                            <h3 class="heading-small mb-4">How old are you?</h3>
                            <div class="flex justify-center gap-4 flex-wrap">
                                <button class="age-group-btn btn btn-secondary" data-age="3-4" aria-label="Age 3 to 4">
                                    <span class="text-2xl mb-2 block">üê£</span>
                                    <span>3-4 years</span>
                                </button>
                                <button class="age-group-btn btn btn-secondary" data-age="4-5" aria-label="Age 4 to 5">
                                    <span class="text-2xl mb-2 block">üå±</span>
                                    <span>4-5 years</span>
                                </button>
                                <button class="age-group-btn btn btn-secondary" data-age="5-6" aria-label="Age 5 to 6">
                                    <span class="text-2xl mb-2 block">üåü</span>
                                    <span>5-6 years</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Get started button -->
                        <button id="get-started-btn" class="btn btn-primary btn-large" disabled>
                            Let's Start Learning! üöÄ
                        </button>
                    </div>
                    
                    <!-- Features overview -->
                    <div class="grid grid-cols-auto-fit-sm gap-6 max-w-4xl mx-auto">
                        <div class="card text-center">
                            <div class="text-4xl mb-4">üß†</div>
                            <h3 class="heading-small mb-2">Smart Learning</h3>
                            <p class="text-body">AI adapts to your pace and helps you learn better</p>
                        </div>
                        <div class="card text-center">
                            <div class="text-4xl mb-4">üéÆ</div>
                            <h3 class="heading-small mb-2">Fun Games</h3>
                            <p class="text-body">Learn through play with colorful, engaging activities</p>
                        </div>
                        <div class="card text-center">
                            <div class="text-4xl mb-4">üìä</div>
                            <h3 class="heading-small mb-2">Track Progress</h3>
                            <p class="text-body">See your improvement and celebrate achievements</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Game Selection Screen -->
            <section id="game-selection-screen" class="screen">
                <div class="container mx-auto px-4 py-8">
                    <div class="text-center mb-8">
                        <h2 class="heading-large mb-4">Choose Your Adventure!</h2>
                        <p class="text-body">Pick a game to start your learning journey</p>
                    </div>
                    
                    <!-- Available games grid -->
                    <div id="available-games" class="game-grid mb-8">
                        <!-- Games will be populated by JavaScript -->
                    </div>
                    
                    <!-- Locked games (for guests) -->
                    <div id="locked-games" class="hidden">
                        <div class="text-center mb-6">
                            <h3 class="heading-medium mb-2">üîí More Adventures Await!</h3>
                            <p class="text-body mb-4">Sign in to unlock all games and track your progress</p>
                            <button id="show-signin-btn" class="btn btn-primary">Sign In to Unlock</button>
                        </div>
                        <div id="locked-games-grid" class="game-grid opacity-50">
                            <!-- Locked games will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- User progress overview -->
                    <div id="progress-overview" class="hidden card p-6 mt-8">
                        <h3 class="heading-medium mb-4">Your Progress</h3>
                        <div id="progress-stats" class="stats-grid">
                            <!-- Progress stats will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Game Play Screen -->
            <section id="game-screen" class="screen">
                <div class="container mx-auto px-4 py-8 max-w-4xl">
                    
                    <!-- Game header -->
                    <div class="flex justify-between items-center mb-6">
                        <button id="pause-game-btn" class="btn btn-secondary" aria-label="Pause game">
                            ‚è∏Ô∏è Pause
                        </button>
                        
                        <div class="text-center">
                            <h2 id="game-title" class="heading-medium mb-1">Number Magic</h2>
                            <div class="text-caption" id="game-progress">Question 1 of 10</div>
                        </div>
                        
                        <button id="quit-game-btn" class="btn btn-secondary" aria-label="Quit game">
                            ‚ùå Quit
                        </button>
                    </div>
                    
                    <!-- Progress bar -->
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="game-progress-fill" class="progress-fill" style="width: 10%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="accuracy-display">Accuracy: 100%</span>
                        </div>
                    </div>
                    
                    <!-- Question container -->
                    <div id="question-container" class="question-container">
                        <h3 id="question-text" class="question-text">Loading question...</h3>
                        
                        <!-- Visual representation area -->
                        <div id="question-visual" class="question-visual" aria-label="Visual representation">
                            <!-- Visuals will be populated by JavaScript -->
                        </div>
                        
                        <!-- Answer options -->
                        <div id="answer-options" class="answer-grid" role="group" aria-label="Answer choices">
                            <!-- Answer buttons will be populated by JavaScript -->
                        </div>
                        
                        <!-- Hint button -->
                        <div class="text-center mt-4">
                            <button id="hint-btn" class="btn btn-secondary hidden" aria-label="Get hint">
                                üí° Need a Hint?
                            </button>
                        </div>
                    </div>
                    
                    <!-- AI Feedback Panel -->
                    <div id="ai-feedback-panel" class="ai-panel hidden" role="region" aria-label="Learning feedback">
                        <div class="flex items-start gap-4">
                            <div class="ai-avatar" aria-hidden="true">ü§ñ</div>
                            <div class="flex-1">
                                <div id="ai-message" class="ai-message">Great work! Keep it up!</div>
                                <div id="ai-encouragement" class="text-caption mt-2 text-accent-green hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Results Screen -->
            <section id="results-screen" class="screen">
                <div class="container mx-auto px-4 py-8 max-w-2xl text-center">
                    <div class="mb-8">
                        <div id="results-emoji" class="text-8xl mb-6 animate-bounce-in">üéâ</div>
                        <h2 id="results-title" class="heading-large mb-4">Fantastic Work!</h2>
                        <p id="results-message" class="text-body mb-6">You're getting better at math every day!</p>
                    </div>
                    
                    <!-- Game statistics -->
                    <div id="results-stats" class="stats-grid mb-8">
                        <!-- Stats will be populated by JavaScript -->
                    </div>
                    
                    <!-- Achievements -->
                    <div id="achievements-section" class="hidden mb-8">
                        <h3 class="heading-medium mb-4">New Achievements! üèÜ</h3>
                        <div id="achievements-list" class="flex flex-wrap justify-center gap-2">
                            <!-- Achievements will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- AI Learning Insights -->
                    <div id="learning-insights" class="ai-panel mb-8 hidden">
                        <h3 class="heading-small mb-3">üß† Learning Insights</h3>
                        <div id="insights-content">
                            <!-- Insights will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Action buttons -->
                    <div class="flex flex-col gap-4">
                        <button id="play-again-btn" class="btn btn-primary btn-large">
                            üîÑ Play Again
                        </button>
                        <button id="try-different-game-btn" class="btn btn-secondary">
                            üéÆ Try Different Game
                        </button>
                        <button id="back-to-games-btn" class="btn btn-secondary">
                            üè† Back to Games
                        </button>
                    </div>
                </div>
            </section>

            <!-- Settings Screen -->
            <section id="settings-screen" class="screen">
                <div class="container mx-auto px-4 py-8 max-w-2xl">
                    <div class="flex items-center mb-8">
                        <button id="close-settings-btn" class="nav-button mr-4" aria-label="Close settings">
                            ‚Üê
                        </button>
                        <h2 class="heading-large">Settings</h2>
                    </div>
                    
                    <!-- Settings groups -->
                    <div class="space-y-8">
                        
                        <!-- Account settings -->
                        <div class="settings-group">
                            <h3 class="settings-title">Account</h3>
                            <div id="account-settings">
                                <!-- Will be populated based on user type -->
                            </div>
                        </div>
                        
                        <!-- Game preferences -->
                        <div class="settings-group">
                            <h3 class="settings-title">Game Preferences</h3>
                            
                            <div class="settings-item">
                                <label class="settings-label" for="age-group-select">Age Group</label>
                                <select id="age-group-select" class="form-select settings-control">
                                    <option value="3-4">3-4 years</option>
                                    <option value="4-5">4-5 years</option>
                                    <option value="5-6">5-6 years</option>
                                </select>
                            </div>
                            
                            <div class="settings-item">
                                <label class="settings-label" for="sound-toggle">Sound Effects</label>
                                <div class="settings-control">
                                    <button id="sound-toggle" class="toggle-switch" role="switch" aria-checked="true">
                                        <div class="toggle-thumb"></div>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="settings-item">
                                <label class="settings-label" for="animations-toggle">Animations</label>
                                <div class="settings-control">
                                    <button id="animations-toggle" class="toggle-switch checked" role="switch" aria-checked="true">
                                        <div class="toggle-thumb"></div>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="settings-item">
                                <label class="settings-label" for="hints-toggle">Show Hints</label>
                                <div class="settings-control">
                                    <button id="hints-toggle" class="toggle-switch checked" role="switch" aria-checked="true">
                                        <div class="toggle-thumb"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Accessibility -->
                        <div class="settings-group">
                            <h3 class="settings-title">Accessibility</h3>
                            
                            <div class="settings-item">
                                <label class="settings-label" for="font-size-select">Text Size</label>
                                <select id="font-size-select" class="form-select settings-control">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            
                            <div class="settings-item">
                                <label class="settings-label" for="high-contrast-toggle">High Contrast</label>
                                <div class="settings-control">
                                    <button id="high-contrast-toggle" class="toggle-switch" role="switch" aria-checked="false">
                                        <div class="toggle-thumb"></div>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="settings-item">
                                <label class="settings-label" for="reduced-motion-toggle">Reduce Motion</label>
                                <div class="settings-control">
                                    <button id="reduced-motion-toggle" class="toggle-switch" role="switch" aria-checked="false">
                                        <div class="toggle-thumb"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- About -->
                        <div class="settings-group">
                            <h3 class="settings-title">About</h3>
                            <div class="card p-4">
                                <h4 class="heading-small mb-2">Kindergarten Math Adventure v3</h4>
                                <p class="text-caption mb-3">AI-powered learning games for children aged 3-6</p>
                                <p class="text-caption text-text-muted">
                                    Created with ‚ù§Ô∏è for young learners everywhere
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->
    
    <!-- Pause Modal -->
    <div id="pause-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pause-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="pause-modal-title" class="modal-title">Game Paused</h3>
                <button class="modal-close" aria-label="Close modal">‚úï</button>
            </div>
            <div class="modal-body text-center">
                <div class="text-6xl mb-4">‚è∏Ô∏è</div>
                <p class="text-body mb-6">Take a break! Your progress is saved.</p>
                <div class="space-y-3">
                    <button id="resume-game-btn" class="btn btn-primary btn-large w-full">
                        ‚ñ∂Ô∏è Resume Game
                    </button>
                    <button id="quit-to-games-btn" class="btn btn-secondary w-full">
                        üè† Back to Games
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sign In Modal -->
    <div id="signin-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="signin-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="signin-modal-title" class="modal-title">Sign In</h3>
                <button class="modal-close" aria-label="Close modal">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-3">üöÄ</div>
                    <p class="text-body">Sign in to unlock all games and track your learning progress!</p>
                </div>
                
                <!-- Sign in form placeholder -->
                <div class="space-y-4">
                    <div class="text-center">
                        <p class="text-caption text-text-muted">Authentication will be implemented with Supabase</p>
                        <button id="demo-signin-btn" class="btn btn-primary mt-4">
                            Demo Sign In (Development)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        console.log('üöÄ Starting Kindergarten Math Adventure v3...');
        
        let moduleLoadingFailed = false;
        let fallbackActivated = false;
        
        // Global error handler
        window.addEventListener('error', (e) => {
            console.error('‚ùå Global error:', e.error);
            if (e.filename && e.filename.includes('src/js/')) {
                console.warn('‚ö†Ô∏è Module loading error detected');
                moduleLoadingFailed = true;
            }
        });
        
        // Module loading error handler
        window.addEventListener('unhandledrejection', (e) => {
            console.error('‚ùå Unhandled promise rejection:', e.reason);
            if (e.reason && e.reason.toString().includes('import')) {
                console.warn('‚ö†Ô∏è Module import error detected');
                moduleLoadingFailed = true;
            }
        });
        
        // Fallback initialization after 5 seconds
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            const appElement = document.getElementById('app');
            
            if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                console.warn('‚ö†Ô∏è Loading timeout - activating fallback mode');
                activateFallbackMode();
            }
        }, 5000);
        
        // Simplified fallback app
        function activateFallbackMode() {
            if (fallbackActivated) return;
            fallbackActivated = true;
            
            console.log('üîÑ Activating simplified fallback mode...');
            
            // Hide loading, show app
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Initialize simplified functionality
            initializeFallbackApp();
        }
        
        function initializeFallbackApp() {
            console.log('üéØ Initializing fallback app with basic functionality...');
            
            let selectedAge = null;
            
            // Hide navigation and other elements not needed in fallback mode
            const navbar = document.querySelector('.navbar');
            const offlineBanner = document.getElementById('offline-banner');
            
            if (navbar) navbar.style.display = 'none';
            if (offlineBanner) offlineBanner.style.display = 'none';
            
            // Show welcome screen
            showScreen('welcome');
            
            // Setup age selection
            document.querySelectorAll('.age-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    selectedAge = btn.dataset.age;
                    
                    // Update selection
                    document.querySelectorAll('.age-group-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    // Enable get started button
                    const startBtn = document.getElementById('get-started-btn');
                    if (startBtn) {
                        startBtn.disabled = false;
                    }
                    
                    console.log('Age selected:', selectedAge);
                });
            });
            
            // Setup get started button
            const getStartedBtn = document.getElementById('get-started-btn');
            if (getStartedBtn) {
                getStartedBtn.addEventListener('click', () => {
                    if (selectedAge) {
                        console.log('Starting game selection for age:', selectedAge);
                        showGameSelection();
                    }
                });
            }
            
            // Setup game buttons
            setupGameButtons();
            
            console.log('‚úÖ Fallback app initialized successfully');
        }
        
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenName + '-screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }
        
        function showGameSelection() {
            // Create game selection content
            const gameSelectionScreen = document.getElementById('game-selection-screen');
            if (gameSelectionScreen) {
                gameSelectionScreen.innerHTML = `
                    <div class="container mx-auto px-4 py-16 max-w-6xl">
                        <div class="text-center mb-12">
                            <h2 class="text-4xl font-bold mb-6 text-text-primary">Choose Your Adventure!</h2>
                            <p class="text-xl text-text-secondary">Pick a game to start your learning journey</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
                            <div class="game-card" onclick="startDemo('number-magic')">
                                <div class="text-6xl mb-4">üßÆ</div>
                                <h3 class="text-2xl font-bold mb-3 text-text-primary">Number Magic</h3>
                                <p class="text-text-secondary mb-6">Master numbers through magical adventures!</p>
                                <button class="btn btn-primary w-full">üöÄ Play Now</button>
                            </div>
                            
                            <div class="game-card opacity-50">
                                <div class="text-6xl mb-4">üïê</div>
                                <h3 class="text-2xl font-bold mb-3 text-text-muted">Time Wizard</h3>
                                <p class="text-text-muted mb-6">Learn to read clocks like a time wizard!</p>
                                <button class="btn btn-secondary w-full" disabled>üîí Coming Soon</button>
                            </div>
                            
                            <div class="game-card opacity-50">
                                <div class="text-6xl mb-4">üîÆ</div>
                                <h3 class="text-2xl font-bold mb-3 text-text-muted">Pattern Quest</h3>
                                <p class="text-text-muted mb-6">Discover magical patterns and sequences!</p>
                                <button class="btn btn-secondary w-full" disabled>üîí Coming Soon</button>
                            </div>
                        </div>
                        
                        <div class="text-center mt-12">
                            <button class="btn btn-secondary" onclick="showScreen('welcome')">‚Üê Back to Welcome</button>
                        </div>
                    </div>
                `;
                showScreen('game-selection');
            }
        }
        
        function setupGameButtons() {
            // Make functions globally available
            window.startDemo = function(gameId) {
                console.log('Starting demo for:', gameId);
                
                // Show demo message
                const gameScreen = document.getElementById('game-screen');
                if (gameScreen) {
                    gameScreen.innerHTML = `
                        <div class="container mx-auto px-4 py-16 max-w-4xl text-center">
                            <h2 class="text-4xl font-bold mb-6 text-text-primary">üßÆ Number Magic Demo</h2>
                            <div class="card max-w-2xl mx-auto">
                                <div class="text-6xl mb-6">üéâ</div>
                                <h3 class="text-2xl font-semibold mb-4 text-text-primary">Fallback Mode Active!</h3>
                                <p class="text-text-secondary mb-6">
                                    The interface is working in simplified mode while we load the full AI-powered game system.
                                </p>
                                <p class="text-text-muted mb-8">
                                    The complete Number Magic game with adaptive difficulty, visual math, and AI learning 
                                    is being initialized in the background. This may take a moment on first load.
                                </p>
                                <div class="space-y-4">
                                    <button class="btn btn-primary" onclick="showGameSelection()">üéÆ Back to Games</button>
                                    <br>
                                    <button class="btn btn-secondary" onclick="window.location.reload()">üîÑ Reload Full App</button>
                                </div>
                            </div>
                        </div>
                    `;
                    showScreen('game');
                }
            };
            
            window.showScreen = showScreen;
            window.showGameSelection = showGameSelection;
        }
    </script>
    
    <!-- Try loading the full module system with error handling -->
    <script type="module">
        console.log('üì¶ Attempting to load full module system...');
        
        try {
            // Test if modules work at all
            import('./src/js/config.js')
                .then(config => {
                    console.log('‚úÖ Config module loaded successfully');
                    
                    // If config loads, try loading the full app
                    return import('./src/js/app.js');
                })
                .then(() => {
                    console.log('‚úÖ Full module system loaded successfully');
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è Module loading failed, using fallback:', error.message);
                    
                    // If modules fail, make sure fallback is activated
                    setTimeout(() => {
                        if (!window.app || !window.app.isInitialized) {
                            console.log('üîÑ Modules failed - forcing fallback activation');
                            activateFallbackMode();
                        }
                    }, 1000);
                });
                
        } catch (error) {
            console.warn('‚ö†Ô∏è Module import syntax not supported, using fallback');
            setTimeout(activateFallbackMode, 500);
        }
    </script>
    
    <!-- Fallback non-module script loader -->
    <script>
        // Double-check initialization after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                    console.log('üîÑ DOM loaded but app not initialized - activating fallback');
                    activateFallbackMode();
                }
            }, 2000);
        });
    </script>
</body>
</html>